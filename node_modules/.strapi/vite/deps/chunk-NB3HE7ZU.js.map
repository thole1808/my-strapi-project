{
  "version": 3,
  "sources": ["../../../@strapi/content-manager/admin/src/hooks/useOnce.ts", "../../../@strapi/content-manager/admin/src/pages/EditView/EditViewPage.tsx"],
  "sourcesContent": ["/* eslint-disable react-hooks/exhaustive-deps */\nimport * as React from 'react';\n\nexport const useOnce = (effect: React.EffectCallback) => React.useEffect(effect, emptyDeps);\n\nconst emptyDeps: React.DependencyList = [];\n", "import * as React from 'react';\n\nimport {\n  Page,\n  Blocker,\n  Form,\n  useRBAC,\n  useNotification,\n  useQueryParams,\n} from '@strapi/admin/strapi-admin';\nimport { Grid, Main, Tabs } from '@strapi/design-system';\nimport { useIntl } from 'react-intl';\nimport { useLocation, useParams } from 'react-router-dom';\nimport { styled } from 'styled-components';\n\nimport { SINGLE_TYPES } from '../../constants/collections';\nimport { PERMISSIONS } from '../../constants/plugin';\nimport { DocumentRBAC, useDocumentRBAC } from '../../features/DocumentRBAC';\nimport { type UseDocument, useDoc } from '../../hooks/useDocument';\nimport { useDocumentLayout } from '../../hooks/useDocumentLayout';\nimport { useLazyComponents } from '../../hooks/useLazyComponents';\nimport { useOnce } from '../../hooks/useOnce';\nimport { getTranslation } from '../../utils/translations';\nimport { createYupSchema } from '../../utils/validation';\n\nimport { FormLayout } from './components/FormLayout';\nimport { Header } from './components/Header';\nimport { Panels } from './components/Panels';\nimport { transformDocument } from './utils/data';\nimport { createDefaultForm } from './utils/forms';\n\n/* -------------------------------------------------------------------------------------------------\n * EditViewPage\n * -----------------------------------------------------------------------------------------------*/\n\nconst EditViewPage = () => {\n  const location = useLocation();\n  const [\n    {\n      query: { status },\n    },\n    setQuery,\n  ] = useQueryParams<{ status: 'draft' | 'published' }>({\n    status: 'draft',\n  });\n  const { formatMessage } = useIntl();\n  const { toggleNotification } = useNotification();\n\n  const {\n    document,\n    meta,\n    isLoading: isLoadingDocument,\n    schema,\n    components,\n    collectionType,\n    id,\n    model,\n    hasError,\n    getTitle,\n    getInitialFormValues,\n  } = useDoc();\n\n  const hasDraftAndPublished = schema?.options?.draftAndPublish ?? false;\n\n  useOnce(() => {\n    /**\n     * We only ever want to fire the notification once otherwise\n     * whenever the app re-renders it'll pop up regardless of\n     * what we do because the state comes from react-router-dom\n     */\n    if (location?.state && 'error' in location.state) {\n      toggleNotification({\n        type: 'danger',\n        message: location.state.error,\n        timeout: 5000,\n      });\n    }\n  });\n\n  const isLoadingActionsRBAC = useDocumentRBAC('EditViewPage', (state) => state.isLoading);\n\n  const isSingleType = collectionType === SINGLE_TYPES;\n\n  /**\n   * single-types don't current have an id, but because they're a singleton\n   * we can simply use the update operation to continuously update the same\n   * document with varying params.\n   */\n  const isCreatingDocument = !id && !isSingleType;\n\n  const {\n    isLoading: isLoadingLayout,\n    edit: {\n      layout,\n      settings: { mainField },\n    },\n  } = useDocumentLayout(model);\n\n  const { isLazyLoading } = useLazyComponents([]);\n\n  const isLoading = isLoadingActionsRBAC || isLoadingDocument || isLoadingLayout || isLazyLoading;\n\n  const initialValues = getInitialFormValues(isCreatingDocument);\n\n  if (hasError) {\n    return <Page.Error />;\n  }\n\n  if (isLoading && !document?.documentId) {\n    return <Page.Loading />;\n  }\n\n  if (!initialValues) {\n    return <Page.Error />;\n  }\n\n  const handleTabChange = (status: string) => {\n    if (status === 'published' || status === 'draft') {\n      setQuery({ status }, 'push', true);\n    }\n  };\n\n  const validateSync = (values: Record<string, unknown>, options: Record<string, string>) => {\n    const yupSchema = createYupSchema(schema?.attributes, components, {\n      status,\n      ...options,\n    });\n\n    return yupSchema.validateSync(values, { abortEarly: false });\n  };\n\n  return (\n    <Main paddingLeft={10} paddingRight={10}>\n      <Page.Title>{getTitle(mainField)}</Page.Title>\n      <Form\n        disabled={hasDraftAndPublished && status === 'published'}\n        initialValues={initialValues}\n        method={isCreatingDocument ? 'POST' : 'PUT'}\n        validate={(values: Record<string, unknown>, options: Record<string, string>) => {\n          const yupSchema = createYupSchema(schema?.attributes, components, {\n            status,\n            ...options,\n          });\n\n          return yupSchema.validate(values, { abortEarly: false });\n        }}\n        initialErrors={location?.state?.forceValidation ? validateSync(initialValues, {}) : {}}\n      >\n        {({ resetForm }) => (\n          <>\n            <Header\n              isCreating={isCreatingDocument}\n              status={hasDraftAndPublished ? getDocumentStatus(document, meta) : undefined}\n              title={getTitle(mainField)}\n            />\n            <Tabs.Root variant=\"simple\" value={status} onValueChange={handleTabChange}>\n              <Tabs.List\n                aria-label={formatMessage({\n                  id: getTranslation('containers.edit.tabs.label'),\n                  defaultMessage: 'Document status',\n                })}\n              >\n                {hasDraftAndPublished ? (\n                  <>\n                    <StatusTab value=\"draft\">\n                      {formatMessage({\n                        id: getTranslation('containers.edit.tabs.draft'),\n                        defaultMessage: 'draft',\n                      })}\n                    </StatusTab>\n                    <StatusTab\n                      disabled={!meta || meta.availableStatus.length === 0}\n                      value=\"published\"\n                    >\n                      {formatMessage({\n                        id: getTranslation('containers.edit.tabs.published'),\n                        defaultMessage: 'published',\n                      })}\n                    </StatusTab>\n                  </>\n                ) : null}\n              </Tabs.List>\n              <Grid.Root paddingTop={8} gap={4}>\n                <Grid.Item col={9} s={12} direction=\"column\" alignItems=\"stretch\">\n                  <Tabs.Content value=\"draft\">\n                    <FormLayout layout={layout} />\n                  </Tabs.Content>\n                  <Tabs.Content value=\"published\">\n                    <FormLayout layout={layout} />\n                  </Tabs.Content>\n                </Grid.Item>\n                <Grid.Item col={3} s={12} direction=\"column\" alignItems=\"stretch\">\n                  <Panels />\n                </Grid.Item>\n              </Grid.Root>\n            </Tabs.Root>\n            <Blocker\n              // We reset the form to the published version to avoid errors like â€“ https://strapi-inc.atlassian.net/browse/CONTENT-2284\n              onProceed={resetForm}\n            />\n          </>\n        )}\n      </Form>\n    </Main>\n  );\n};\n\nconst StatusTab = styled(Tabs.Trigger)`\n  text-transform: uppercase;\n`;\n\n/**\n * @internal\n * @description Returns the status of the document where its latest state takes priority,\n * this typically will be \"published\" unless a user has edited their draft in which we should\n * display \"modified\".\n */\nconst getDocumentStatus = (\n  document: ReturnType<UseDocument>['document'],\n  meta: ReturnType<UseDocument>['meta']\n): 'draft' | 'published' | 'modified' => {\n  const docStatus = document?.status;\n  const statuses = meta?.availableStatus ?? [];\n\n  /**\n   * Creating an entry\n   */\n  if (!docStatus) {\n    return 'draft';\n  }\n\n  /**\n   * We're viewing a draft, but the document could have a published version\n   */\n  if (docStatus === 'draft' && statuses.find((doc) => doc.publishedAt !== null)) {\n    return 'published';\n  }\n\n  return docStatus;\n};\n\n/* -------------------------------------------------------------------------------------------------\n * ProtectedEditViewPage\n * -----------------------------------------------------------------------------------------------*/\n\nconst ProtectedEditViewPage = () => {\n  const { slug = '' } = useParams<{\n    slug: string;\n  }>();\n  const {\n    permissions = [],\n    isLoading,\n    error,\n  } = useRBAC(\n    PERMISSIONS.map((action) => ({\n      action,\n      subject: slug,\n    }))\n  );\n\n  if (isLoading) {\n    return <Page.Loading />;\n  }\n\n  if (error || !slug) {\n    return <Page.Error />;\n  }\n\n  return (\n    <Page.Protect permissions={permissions}>\n      {({ permissions }) => (\n        <DocumentRBAC permissions={permissions}>\n          <EditViewPage />\n        </DocumentRBAC>\n      )}\n    </Page.Protect>\n  );\n};\n\nexport { EditViewPage, ProtectedEditViewPage, getDocumentStatus };\n"],
  "mappings": "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",
  "names": ["status", "permissions"]
}
